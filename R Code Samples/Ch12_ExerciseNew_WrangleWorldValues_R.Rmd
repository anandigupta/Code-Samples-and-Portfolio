---
title: "Ch12_Exercise_WrangleWVS"
output: html_document
author: Anandi Gupta
---

## Preparation

```{r setup, include=TRUE, message = FALSE, warning = FALSE}
# Load packages used in this session of R
library(knitr)
library(dplyr)
library(mfx)

opts_chunk$set(echo = TRUE)
options(digits = 2)
opts_knit$set(root.dir = "/Users/anandigupta/Downloads")
```

#### 1) Load the World Values Survey data from "Data/WV7_small.csv" and the CountryCode data from "Data/Country codes for WVS wave 7.csv".
The codebook for the World Values Survey data is available at 
http://www.worldvaluessurvey.org/WVSDocumentationWV7.jsp

- Satisfaction with your life from 1 (completely dissatisfied) to 10 (completely satisfied) (*V23*)
- Income: a country-specific scale ranging from 1 (lowest income category) to 10 (highest income category) (*V239* in the dataset)
- Education: a scale ranging from 1 (no formal education) to 9 (a degree from a university) (*V248* in the dataset)
- Country: based on *V2* in the dataset.  See “Country codes for WVS wave 6.csv”
- Conservatism: self-identified political conservatism from 1 (most liberal) to 10 (most conservative) (*V95* in the data set)
- Male: a dummy variable indicating male (*V240*)
- Religious: Indicating how often the individual attends religious services ranging from 1 (almost never) to 7 (more than once a week) (this is a re-coding of *V145* that had the polarity reversed, but is harder to interpret)



```{r}
wv<- read.csv("WV7_small.csv")
CountryCode<- read.csv("Country codes for WVS wave 7.csv")
```


#### 2) Join the country name from the CountryCode data to the World Values data.  The country code is *V2* in CountryCode and *B_Country* in the World Values data.  Create two data objects of the countries in and not in the World Values data. Display the first 10 countries for each list.

```{r}
# Join wv to CountryCode
wv <- wv %>% 
  left_join(CountryCode, by = c("B_COUNTRY" = "V2"))
head(wv)
```

```{r}
# Countries in wv 
wv_in <- unique(wv$country)
wv_in[1:10]
```


```{r}
# Countries not in wv 
wv_notin <- CountryCode %>% 
  anti_join(wv, by = c("V2" = "B_COUNTRY")) %>% 
  pull()
wv_notin[1:10]
```


#### 3) Create a function using pipes that calculates the mean and number of observations for the *Satisfied* (life satisfaction) variable by male and female for a given country name.

```{r}
meanSatGender = function(cc) {

  wv %>% 
#Filter to inputted country
    filter(country == cc) %>% 
#Group by male
    group_by(Male) %>% 
#Calculate mean satisfaction for each group
    summarize(mean_sat = mean(Satisfied, na.rm= TRUE), 
              obs = n())
}

#Output for a given country
meanSatGender("China")

```

#### 4) Using pipes, calculate the percent immigrant in every country. Show the highest 10 and lowest 10 countries. (Be sure to think through what the variable in the data set means.) 

```{r}
#check for unique values of immigrant variable
unique(wv$Immigrant)
#from code book, 1 is U.S born, 2 is immigrant
```

```{r}
#recode to dummy variable - 1 for immigrant
wv = wv %>% mutate(Immigrant = Immigrant - 1)
```


```{r}
# Calculate the percent immigrant in every country
Immigrants <- wv %>% 
  group_by(country) %>% 
  summarize(ImmPct = mean(Immigrant, na.rm= TRUE), 
            n = n())
```


```{r}
# Show countries with the lowest immigration
Immigrants %>% 
  arrange(ImmPct) %>%
  slice(1:10)
```
```{r}
# Show countries with the highest immigration
Immigrants %>% 
  arrange(desc(ImmPct)) %>% 
  slice(1:10)
```

#### 5) We're now going to give some examples of the kind of data we can calculate.  Think about how you would do this in Excel (but don't actually do it!) and then calculate in R. Calculate the percent of immigrants who are men, by country and show the highest and lowest 10 countries.
```{r}
# Calculate the percent of immigrants who are men, 
# by country and sorted from high to low
ImmigrantsPctMale <- wv %>% 
  filter(Immigrant == 1) %>% 
  group_by(country) %>% 
  summarize(MalePct = mean(Male, na.rm= TRUE), 
            n = n()) 
```

```{r}
# Show countries with the lowest male immigrants
ImmigrantsPctMale %>% 
  arrange((MalePct)) %>% 
  slice(1:10)
```

```{r}
# Show countries with the highest male immigrants
ImmigrantsPctMale %>% 
  arrange((desc(MalePct))) %>% 
  slice(1:10)
```

#### 6) Calculate the percent of who are men, by marital status and country and show results for a country of interest and briefly discuss what the results mean for that country. Recall that the coding for the *Marital* variable is 1 = Married 2 = Living together as married 3 = Divorced 4 = Separated 5 = Widowed 6 = Single.

```{r}
# Calculate the percent male by marital status
MaritalPctMale = wv %>% 
  group_by(country, Marital) %>% 
  summarize(MalePct = mean(Male, na.rm= TRUE), 
            n = n())
```

```{r}
# Show for selected country
MaritalPctMale %>%
  filter(country == "China")
```

If we assume only hetero normative couples, you would expect that married, living together, divorced, and separated categories would each have approximately 50% men. However, the sample does not cover couples, so if these variables were not close to 50% it may be "luck of the draw", that the married people were predominantly men or women. It could also be an indicator that the sample itself may have more of one gender or the other. Alternatively, it could be biased by missing values, if women or men systematically were less likely to answer questions on marital status. 


#### 7) Estimate a LPM/logit/probit models predicting divorce/separation as a function of income, education, gender and age in a selected country. Briefly compare statistical significance and estimated effects across models for the gender dummy variable and the age variable.


```{r}
#create categorical variable for divorced/separated
wv$divorced<- ifelse(( wv$Marital== 3 | wv$Marital== 4), 1 , 0)
```

```{r}
lpm = function(cc) {

lpm.1 <- lm(divorced ~ Age + Income + Education + Male, data = wv[wv$country == cc,])
round(summary(lpm.1)$coefficients, digits = 4)
}

lpm("China")
```



```{r}
pm = function(cc) {
  
  #Model Divorce (Probit)
  pm.1 = glm(divorced ~ Age + Income + Education + Male, data = wv[wv$country== cc,], family = binomial(link = "probit"))
  
  ## Use the mfx package (installed above)
probitmfx(pm.1, data = wv[wv$country== cc,], atmean = FALSE)
  
}
pm("China")
```

```{r}
logit_model= function(cc) {
  #Model Divorce (Logit)
  lm.1 = glm(divorced ~ Age + Income + Education + Male, data = wv[wv$country== cc,], family = binomial(link = "logit"))
  
  ## Use the mfx package (installed above)
probitmfx(lm.1, data = wv[wv$country== cc,], atmean = FALSE)
}
logit_model("China")
```

We see that the statistical significance are for the age and male variables are similar across all 3 models. The coefficients of the probit and logit models are difficult to interpret. However, when we look at the marginal effects of the models, we see that they are comparable to the effects seen in the linear probability model (A unit increase in age is associated with a .01% decrease in the probability of being divorced, and being male is associated with a .3% decrease in the likelihood of being divorced. However, neither of these effects are statistically significant in China).


#### 8) BONUS (not required) Suppose you want to compare the effect of eduction on divorce in two countries.  Based on the above model, answer the question of whether the effect of education on divorce is higher in Country A compared to Country B.  Feel free to explore differential effects for other variables.

```{r}
lpm("United States")
```

```{r}
pm("United States")
```


```{r}
logit_model("United States")
```

We see that in China, the likelihood of being divorced decreases by 0.4% for every 1 unit increase in education level (statistically significant effect). However in the United States, we see no significant effect of education on the likelihood of being divorced.


